<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Dashboard</title>
    <style>
      .artwork {
        width: 100px;
        height: 100px;
        margin: 10px;
        cursor: pointer;
        border: 2px solid transparent;
      }

      .artwork.selected {
        border: 2px solid blue;
      }

      .recording {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .recording img {
        width: 50px;
        height: 50px;
        margin-right: 10px;
      }

      .recording div {
        margin-right: 10px;
      }

      .recording form {
        display: flex;
        align-items: center;
      }
    </style>
    <script>
      let intervalId;

      function startRecording() {
        fetch("recording/start", { method: "POST" }).then((response) => {
          if (response.ok) {
            intervalId = setInterval(updateRecordingTime, 1000);
          }
        });
      }

      function stopRecording() {
        fetch("recording/stop", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: selectedArtwork ? `existing-artworks=${selectedArtwork}` : "",
        }).then((response) => {
          if (response.ok) {
            clearInterval(intervalId);
            document.getElementById("recording-time").innerText =
              "Recording stopped.";
            fetchRecordings();
          }
        });
      }

      function updateRecordingTime() {
        fetch("recording/status")
          .then((response) => response.json())
          .then((data) => {
            if (data.is_recording) {
              const elapsedTime = Math.floor(data.elapsed_time);
              const minutes = Math.floor(elapsedTime / 60);
              const seconds = elapsedTime % 60;
              document.getElementById(
                "recording-time"
              ).innerText = `Recording: ${minutes}m ${seconds}s`;
            }
          });
      }

      function fetchArtworks() {
        fetch("recording/get_artworks")
          .then((response) => response.json())
          .then((data) => {
            const container = document.getElementById("artworks-container");
            container.innerHTML = "";
            data.forEach((artwork) => {
              const img = document.createElement("img");
              console.log(artwork);
              img.src = `/static/assets/thumbnails/${artwork}`;
              img.classList.add("artwork");
              img.onclick = () => selectArtwork(img, artwork);
              container.appendChild(img);
            });
          });
      }

      function selectArtwork(img, artwork) {
        const artworks = document.querySelectorAll(".artwork");
        artworks.forEach((a) => a.classList.remove("selected"));
        img.classList.add("selected");
        selectedArtwork = artwork;
      }

      function fetchRecordings() {
        fetch("recording/recordings")
          .then((response) => response.json())
          .then((data) => {
            const container = document.getElementById("recordings-container");
            container.innerHTML = "";
            data.recordings.sort((a, b) => new Date(b.date) - new Date(a.date));
            data.recordings.forEach((recording) => {
              const div = document.createElement("div");
              div.classList.add("recording");
              div.innerHTML = `
              <img src="${recording.artwork}" alt="Artwork" />
                <div><strong>Title:</strong> ${recording.title}</div>
                <div><strong>Artist:</strong> ${recording.artist}</div>
                <div><strong>Duration:</strong> ${Math.floor(
                  recording.duration / 60
                )}m ${recording.duration % 60}s</div>
                <div><a href="${recording.stream}">Download</a></div>
                <form action="javascript:void(0);" onsubmit="uploadReplacement(event, '${
                  recording.id
                }')">
                  <input type="file" name="replacement" accept="audio/mp3" required />
                  <button type="submit">Upload Replacement</button>
                </form>
              `;
              container.appendChild(div);
            });
          });
      }

      function uploadReplacement(event, recordingId) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        formData.append("recording_id", recordingId);

        fetch("recording/replace", {
          method: "POST",
          body: formData,
        }).then((response) => {
          if (response.ok) {
            fetchRecordings();
          }
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        fetchArtworks();
        fetchRecordings();
      });
    </script>
  </head>
  <body>
    <h1>Admin Dashboard</h1>
    <p>Welcome to the admin dashboard!</p>
    <a href="{{ url_for('auth.logout') }}">Logout</a>
    <h1>MP3 Stream Recorder</h1>
    <form
      action="javascript:void(0);"
      method="post"
      onsubmit="startRecording()"
    >
      <button type="submit">Start Recording</button>
    </form>
    <form action="javascript:void(0);" method="post" onsubmit="stopRecording()">
      <button type="submit">Stop Recording</button>
    </form>
    <p id="recording-time">Not recording.</p>

    <h2>Upload New Artwork</h2>
    <form
      action="recording/upload_artwork"
      method="post"
      enctype="multipart/form-data"
    >
      <input type="file" name="artwork" accept="image/*" />
      <button type="submit">Upload Artwork</button>
    </form>

    <h2>Select Existing Artwork</h2>
    <div id="artworks-container">
      <!-- Artworks will be populated by JavaScript -->
    </div>

    <h2>Past Recordings</h2>
    <div id="recordings-container">
      <!-- Recordings will be populated by JavaScript -->
    </div>
  </body>
</html>
